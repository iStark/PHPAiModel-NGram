<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<title>Чат на чистом PHP (фиксированный weights50_merged.json)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    :root { --fg:#0e1116; --mut:#556; --ai:#0a63c0; --me:#0b8c6a; --bg:#f6f7fb; }
    @media (prefers-color-scheme: dark){
        :root { --fg:#e7e9ee; --mut:#aab; --ai:#7fb1ff; --me:#77dfc0; --bg:#0b0d12; }
    }
    body{font:16px/1.5 system-ui,Arial,sans-serif;color:var(--fg);background:var(--bg);margin:2rem;max-width:980px}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;margin:.6rem 0}
    input,button{font:inherit;padding:.5rem .6rem;border-radius:.5rem;border:1px solid #c8ccd8;background:#fff}
    @media (prefers-color-scheme: dark){ input,button{background:#12151c;border:1px solid #2a2f3a;color:var(--fg)} }
    input[type=number]{width:7rem} button{cursor:pointer}
    #log{background:#fff;border:1px solid #d9dce6;border-radius:12px;padding:1rem;min-height:220px}
    @media (prefers-color-scheme: dark){ #log{background:#0f131a;border-color:#242a35} }
    .msg{white-space:pre-wrap;margin:.5rem 0}
    .sys{color:#556}.ai{color:#0a63c0}.user{color:#0b8c6a}
    .hint{color:#556;font-size:.9em}
</style>

<h1>Чат (Вес: weights.json)</h1>

<div class="row">
    <button id="reset">Сбросить историю</button>
    <span class="hint">Сервер всегда использует weights50_merged.json</span>
</div>

<div id="log" class="msg sys">Система: готово. Пишите вопрос.</div>

<div class="row">
    <input id="q" placeholder="Сообщение" style="flex:1">
    <button id="send">Отправить</button>
</div>

<div class="row">
    <label>temp <input id="temperature" type="number" step="0.05" value="0.90"></label>
    <label>top_k <input id="top_k" type="number" value="160"></label>
    <label>top_p <input id="top_p" type="number" step="0.01" value="0.95"></label>
    <label>rep_pen <input id="rep_penalty" type="number" step="0.1" value="1.0"></label>
    <label>rep_win <input id="rep_window" type="number" value="180"></label>
    <label>max_tok <input id="max_tokens" type="number" value="140"></label>
</div>

<p class="hint">Если много повторов — rep_penalty 1.2 и rep_window 220; если слишком креативно — temp 0.75 и top_k 100–120.</p>

<script>
    const log = document.getElementById('log');
    const q   = document.getElementById('q');

    function add(who,text,cls=''){ const d=document.createElement('div'); d.className='msg '+cls;
        d.innerHTML=`<b>${who}:</b> `+text.replace(/&/g,'&amp;').replace(/</g,'&lt;'); log.appendChild(d);
        window.scrollTo(0, document.body.scrollHeight); }

    async function send(){
        const text = q.value.trim(); if(!text) return;
        add('Вы', text, 'user'); q.value='';
        const body = {
            message: text,
            temperature: parseFloat(document.getElementById('temperature').value||'0.3'),
            top_k: parseInt(document.getElementById('top_k').value||'140',10),
            top_p: parseFloat(document.getElementById('top_p').value||'0.85'),
            rep_penalty: parseFloat(document.getElementById('rep_penalty').value||'1.0'),
            rep_window: parseInt(document.getElementById('rep_window').value||'180',10),
            max_tokens: parseInt(document.getElementById('max_tokens').value||'140',10)
        };
        const r = await fetch('aicore.php', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        const data = await r.json();
        const meta = data.N ? `\n\n[weights: ${data.weights}, N=${data.N}, tokens=${data.tokens_generated}]` : '';
        add('ИИ', (data.reply || '(пусто)') + meta, 'ai');
    }
    document.getElementById('send').onclick = send;
    q.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });
    document.getElementById('reset').onclick = async ()=>{
        await fetch('reset.php').catch(()=>{});
        add('Система','История сброшена.','sys');
    };
</script>
</html>
